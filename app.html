<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Screen Time Blocker</title>

    <!-- DS one -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ds-one@alpha/DS1/1-root/one.css"
    />
    <script type="module">
      import "https://cdn.jsdelivr.net/npm/ds-one@alpha/dist/ds-one.bundle.min.js";
    </script>

    <style>
      * {
        box-sizing: border-box;
      }

      .hidden {
        display: none !important;
      }

      body {
        margin: 0;
        padding: var(--2);
        min-height: 100vh;
        background: var(--background);
        color: var(--text-color);
        font-family: var(--typeface-regular), system-ui, sans-serif;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      /* Navigation */
      .nav {
        display: flex;
        gap: var(--05);
        margin-bottom: var(--2);
        border-bottom: 1px solid var(--slate-light);
        padding-bottom: var(--05);
      }

      @media (prefers-color-scheme: dark) {
        .nav {
          border-bottom-color: var(--slate-dark);
        }
      }

      .nav-item {
        padding: var(--05) var(--1);
        font-size: calc(14px * var(--sf, 1));
        color: var(--text-color-dimmed);
        text-decoration: none;
        border-radius: var(--025);
        cursor: pointer;
        transition: color 0.15s, background 0.15s;
      }

      .nav-item:hover {
        color: var(--text-color);
        background: var(--slate-light);
      }

      @media (prefers-color-scheme: dark) {
        .nav-item:hover {
          background: var(--slate-dark);
        }
      }

      .nav-item.active {
        color: var(--text-color);
        font-family: var(--typeface-medium), system-ui, sans-serif;
      }

      .setup-check {
        color: var(--every-green);
        margin-left: var(--025);
        vertical-align: middle;
      }

      .setup-check.hidden {
        display: none;
      }

      .nav-spacer {
        flex: 1;
      }

      /* Settings menu */
      .settings-menu {
        position: relative;
      }

      .settings-toggle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--slate-light);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: background 0.15s;
      }

      @media (prefers-color-scheme: dark) {
        .settings-toggle {
          background: var(--slate-dark);
        }
      }

      .settings-toggle:hover {
        background: var(--accent-color);
        color: var(--white);
      }

      .settings-dropdown {
        position: absolute;
        top: calc(100% + var(--05));
        right: 0;
        background: var(--background);
        border: 1px solid var(--slate-light);
        border-radius: var(--025);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        min-width: 220px;
        z-index: 100;
        display: none;
      }

      @media (prefers-color-scheme: dark) {
        .settings-dropdown {
          border-color: var(--slate-dark);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
      }

      .settings-dropdown.open {
        display: block;
      }

      .settings-item {
        padding: var(--1);
        border-bottom: 1px solid var(--slate-light);
      }

      @media (prefers-color-scheme: dark) {
        .settings-item {
          border-bottom-color: var(--slate-dark);
        }
      }

      .settings-item:last-child {
        border-bottom: none;
      }

      .settings-item-label {
        font-size: calc(12px * var(--sf, 1));
        color: var(--text-color-dimmed);
        margin-bottom: var(--025);
      }

      .settings-item-value {
        font-size: calc(14px * var(--sf, 1));
        display: flex;
        align-items: center;
        gap: var(--05);
      }

      .settings-item-note {
        font-size: calc(11px * var(--sf, 1));
        color: var(--text-color-dimmed);
        margin-top: var(--025);
      }

      .notification-status {
        display: inline-flex;
        align-items: center;
        gap: var(--025);
      }

      .notification-status::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--tuned-red);
      }

      .notification-status.enabled::before {
        background: var(--every-green);
      }

      .settings-button {
        width: 100%;
        padding: var(--05) var(--1);
        border: none;
        border-radius: var(--025);
        background: transparent;
        color: var(--text-color);
        font-family: inherit;
        font-size: calc(14px * var(--sf, 1));
        cursor: pointer;
        text-align: left;
      }

      .settings-button:hover {
        background: var(--slate-light);
      }

      @media (prefers-color-scheme: dark) {
        .settings-button:hover {
          background: var(--slate-dark);
        }
      }

      /* Views */
      .view {
        display: none;
      }

      .view.active {
        display: block;
      }

      /* Schedule info bar (above calendar) */
      .schedule-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--1);
        width: 100%;
      }

      .schedule-status {
        font-size: calc(14px * var(--sf, 1));
        color: var(--text-color-dimmed);
      }

      .help-btn {
        background: none;
        border: none;
        padding: var(--025);
        cursor: pointer;
        color: var(--text-color-dimmed);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.15s, background 0.15s;
        margin-left: auto;
      }

      .help-btn:hover {
        color: var(--text-color);
        background: var(--slate-light);
      }

      @media (prefers-color-scheme: dark) {
        .help-btn:hover {
          background: var(--slate-dark);
        }
      }

      .help-popup {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 500;
        padding: var(--2);
      }

      .help-popup.hidden {
        display: none;
      }

      .help-popup-content {
        background: var(--background);
        border-radius: var(--05);
        padding: var(--2);
        max-width: 400px;
        width: 100%;
        position: relative;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .help-popup-close {
        position: absolute;
        top: var(--05);
        right: var(--05);
        background: none;
        border: none;
        font-size: 20px;
        color: var(--text-color-dimmed);
        cursor: pointer;
        line-height: 1;
        padding: var(--025);
      }

      .help-popup-close:hover {
        color: var(--text-color);
      }

      .help-popup-content h4 {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(14px * var(--sf, 1));
        font-weight: 500;
        margin: 0 0 var(--1);
      }

      .help-popup-content ul {
        margin: 0;
        padding-left: var(--2);
        color: var(--text-color-dimmed);
        font-size: calc(14px * var(--sf, 1));
        line-height: 1.6;
      }

      .help-popup-content li {
        margin-bottom: var(--05);
      }

      /* Blocking card */
      .blocking-card {
        background: #dff0ff;
        border-radius: 5px;
        padding: 20px 15px 40px;
        min-height: 236px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      @media (prefers-color-scheme: dark) {
        .blocking-card {
          background: #1a3a5c;
        }
      }

      .blocking-card-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }

      .blocking-session-title {
        font-size: calc(14px * var(--sf, 1));
        color: var(--text-color);
        margin: 0;
      }

      .blocking-session-time {
        font-size: calc(12px * var(--sf, 1));
        color: #565656;
        margin: 0;
      }

      .blocking-session-time .date {
        color: #959595;
      }

      .blocking-helper-text {
        font-size: calc(12px * var(--sf, 1));
        color: #595959;
        margin: var(--1) 0 0;
        padding: 0 10px;
      }

      @media (prefers-color-scheme: dark) {
        .blocking-session-time {
          color: #a0a0a0;
        }
        .blocking-session-time .date {
          color: #777;
        }
        .blocking-helper-text {
          color: #888;
        }
      }

      /* Session ended view */
      .session-ended-title {
        font-size: calc(14px * var(--sf, 1));
        color: var(--text-color);
        margin: 0 0 20px;
        text-align: center;
      }

      .credentials-label {
        font-size: calc(12px * var(--sf, 1));
        color: #595959;
        margin: 0 0 10px;
        text-align: center;
      }

      @media (prefers-color-scheme: dark) {
        .credentials-label {
          color: #888;
        }
      }

      .credential-box {
        background: #c6e5ff;
        border-radius: 3px;
        padding: 10px 15px;
        margin-bottom: 8px;
        text-align: center;
      }

      @media (prefers-color-scheme: dark) {
        .credential-box {
          background: #0d4a7a;
        }
      }

      .credential-box-label {
        font-size: calc(11px * var(--sf, 1));
        color: #595959;
        margin: 0 0 4px;
      }

      @media (prefers-color-scheme: dark) {
        .credential-box-label {
          color: #a0a0a0;
        }
      }

      .credential-box-value {
        font-size: calc(14px * var(--sf, 1));
        color: var(--text-color);
        margin: 0;
        font-family: var(--typeface-mono, monospace), monospace;
        word-break: break-all;
      }

      .session-ended-instructions {
        margin-top: var(--2);
      }

      .session-ended-instructions h3 {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(14px * var(--sf, 1));
        font-weight: 500;
        margin: 0 0 var(--1);
      }

      .session-ended-instructions ol {
        margin: 0;
        padding-left: var(--2);
        color: var(--text-color-dimmed);
        font-size: calc(14px * var(--sf, 1));
        line-height: 1.6;
      }

      .session-ended-instructions li {
        margin-bottom: var(--05);
      }

      .close-session-btn {
        margin-top: var(--2);
      }

      /* Toggle switch */
      .toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--05) 0;
      }

      .toggle-label {
        font-size: calc(14px * var(--sf, 1));
      }

      .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
        background: var(--slate-light);
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.2s;
        flex-shrink: 0;
      }

      @media (prefers-color-scheme: dark) {
        .toggle-switch {
          background: var(--slate-dark);
        }
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: var(--white);
        border-radius: 50%;
        transition: transform 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      .toggle-switch.active {
        background: var(--accent-color);
      }

      .toggle-switch.active::after {
        transform: translateX(20px);
      }

      /* Select dropdown */
      .settings-select {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--05) 0;
      }

      .settings-select select {
        padding: var(--025) var(--05);
        border: 1px solid var(--slate-light);
        border-radius: var(--025);
        background: var(--background);
        color: var(--text-color);
        font-family: inherit;
        font-size: calc(14px * var(--sf, 1));
        cursor: pointer;
      }

      @media (prefers-color-scheme: dark) {
        .settings-select select {
          border-color: var(--slate-dark);
        }
      }

      /* Cards */
      .card {
        background: var(--slate-light);
        border-radius: var(--05);
        padding: var(--2);
        margin-bottom: var(--2);
      }

      @media (prefers-color-scheme: dark) {
        .card {
          background: var(--slate-dark);
        }
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--1);
      }

      .card-title {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(14px * var(--sf, 1));
        font-weight: 500;
        margin: 0;
      }

      /* Instructions */
      .instructions {
        background: var(--slate-light);
        border-radius: var(--05);
        padding: var(--2);
        margin: var(--2) 0;
      }

      @media (prefers-color-scheme: dark) {
        .instructions {
          background: var(--slate-dark);
        }
      }

      .instructions h3 {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(14px * var(--sf, 1));
        font-weight: 500;
        margin: 0 0 var(--1);
      }

      .instructions ol {
        margin: 0;
        padding-left: var(--2);
      }

      .instructions li {
        margin-bottom: var(--05);
        line-height: 1.5;
      }

      /* Page title (Setup, Settings, FAQ) */
      .page-title {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(28px * var(--sf, 1));
        font-weight: 500;
        margin: 0 0 var(--2);
      }

      /* Disabled button state */
      ds-button[disabled] {
        opacity: 0.4;
        pointer-events: none;
      }

      .todo-list {
        list-style: none;
        padding: 0;
        margin: 0 0 var(--2);
      }

      .todo-item {
        display: flex;
        align-items: flex-start;
        gap: var(--1);
        padding: var(--1) 0;
        border-bottom: 1px solid var(--slate-light);
      }

      .todo-number {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(16px * var(--sf, 1));
        color: var(--text-color-dimmed);
        min-width: 24px;
        flex-shrink: 0;
      }

      @media (prefers-color-scheme: dark) {
        .todo-item {
          border-bottom-color: var(--slate-dark);
        }
      }

      .todo-item:last-child {
        border-bottom: none;
      }

      .todo-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid var(--slate-light);
        border-radius: 4px;
        flex-shrink: 0;
        margin-top: 2px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s, border-color 0.15s;
      }

      .todo-checkbox:hover:not(.disabled) {
        border-color: var(--accent-color);
      }

      .todo-checkbox.disabled {
        cursor: default;
      }

      .todo-checkbox.disabled:not(.checked) {
        opacity: 0.5;
      }

      .todo-checkbox.checked {
        background: var(--accent-color);
        border-color: var(--accent-color);
      }

      .todo-checkbox.checked::after {
        content: "✓";
        color: var(--white);
        font-size: 12px;
        font-weight: bold;
      }

      @media (prefers-color-scheme: dark) {
        .todo-checkbox {
          border-color: var(--slate-dark);
        }
      }

      .todo-content {
        flex: 1;
      }

      .todo-content p {
        margin: 0;
        line-height: 1.5;
      }

      .todo-content p.note {
        font-size: calc(12px * var(--sf, 1));
        color: var(--text-color-dimmed);
        margin-top: var(--025);
      }

      .todo-item.collapsed .todo-collapsible {
        display: none;
      }

      .todo-summary {
        display: none;
        font-size: calc(14px * var(--sf, 1));
        color: var(--text-color-dimmed);
        margin-top: var(--025);
      }

      .todo-item.collapsed .todo-summary {
        display: block;
      }

      .todo-item.collapsed .todo-content {
        cursor: pointer;
      }

      .todo-item.collapsed .todo-content p:first-child::after {
        content: " (click to edit)";
        font-size: calc(12px * var(--sf, 1));
        color: var(--text-color-dimmed);
      }

      .section-title {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(16px * var(--sf, 1));
        font-weight: 500;
        margin: var(--2) 0 var(--1);
      }

      .section-title:first-of-type {
        margin-top: 0;
      }

      /* Password reveal */
      .password-box {
        background: var(--background);
        border-radius: var(--025);
        padding: var(--1);
        font-family: var(--typeface-mono), monospace;
        font-size: calc(16px * var(--sf, 1));
        word-break: break-all;
        margin: var(--1) 0;
      }

      .password-actions {
        display: flex;
        gap: var(--1);
      }

      /* Setup flow */
      .setup-step {
        margin-bottom: var(--1);
        color: var(--text-color-dimmed);
      }

      .setup-description {
        margin-bottom: var(--2);
        color: var(--text-color-dimmed);
        line-height: 1.5;
      }

      .form-group {
        margin-bottom: var(--1);
      }

      .form-group label {
        display: block;
        margin-bottom: var(--025);
        font-size: calc(12px * var(--sf, 1));
        color: var(--text-color-dimmed);
      }

      .form-group input {
        width: 100%;
        padding: var(--05) var(--1);
        border: 1px solid var(--slate-light);
        border-radius: var(--025);
        background: var(--background);
        color: var(--text-color);
        font-family: inherit;
        font-size: calc(14px * var(--sf, 1));
      }

      @media (prefers-color-scheme: dark) {
        .form-group input {
          border-color: var(--slate-dark);
        }
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .form-row {
        display: flex;
        gap: var(--1);
        margin-top: var(--1);
      }

      .credential-display {
        font-size: calc(14px * var(--sf, 1));
        margin-bottom: var(--05);
      }

      .credential-display span {
        color: var(--text-color-dimmed);
      }

      .locked-notice {
        text-align: center;
        color: var(--text-color-dimmed);
        font-size: calc(12px * var(--sf, 1));
        margin-top: var(--2);
      }

      /* Unlock countdown */
      .unlock-countdown {
        display: flex;
        align-items: center;
        gap: var(--05);
        font-family: var(--typeface-mono), monospace;
        font-size: calc(14px * var(--sf, 1));
        color: var(--accent-color);
      }

      .unlock-countdown.hidden {
        display: none;
      }

      /* Settings page */

      .settings-section {
        margin-bottom: var(--2);
        padding-bottom: var(--2);
        border-bottom: 1px solid var(--slate-light);
      }

      @media (prefers-color-scheme: dark) {
        .settings-section {
          border-bottom-color: var(--slate-dark);
        }
      }

      .settings-section:last-of-type {
        border-bottom: none;
      }

      .settings-section-title {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(14px * var(--sf, 1));
        font-weight: 500;
        margin: 0 0 var(--05);
        color: var(--text-color-dimmed);
      }

      .settings-email {
        font-size: calc(16px * var(--sf, 1));
        margin: 0;
      }

      .settings-description {
        font-size: calc(14px * var(--sf, 1));
        color: var(--text-color-dimmed);
        margin: 0 0 var(--1);
        line-height: 1.5;
      }

      .settings-notification-row {
        margin: 0 0 var(--05);
      }

      .settings-credential-display {
        font-size: calc(14px * var(--sf, 1));
        margin: 0 0 var(--1);
      }

      .settings-blocked-notice {
        font-size: calc(12px * var(--sf, 1));
        color: var(--tuned-red);
        margin: var(--05) 0 0;
      }

      .settings-blocked-notice.hidden {
        display: none;
      }

      .admin-link {
        color: var(--accent-color);
        text-decoration: none;
        font-size: calc(14px * var(--sf, 1));
      }

      .admin-link:hover {
        text-decoration: underline;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: var(--2);
      }

      .modal-overlay.hidden {
        display: none;
      }

      .modal {
        background: var(--background);
        border-radius: var(--05);
        width: 100%;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--1) var(--2);
        border-bottom: 1px solid var(--slate-light);
      }

      @media (prefers-color-scheme: dark) {
        .modal-header {
          border-bottom-color: var(--slate-dark);
        }
      }

      .modal-title {
        font-family: var(--typeface-medium), system-ui, sans-serif;
        font-size: calc(16px * var(--sf, 1));
        font-weight: 500;
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-color-dimmed);
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }

      .modal-close:hover {
        color: var(--text-color);
      }

      .modal-body {
        padding: var(--2);
      }

      .modal-footer {
        display: flex;
        gap: var(--1);
        justify-content: flex-end;
        padding: var(--1) var(--2);
        border-top: 1px solid var(--slate-light);
      }

      @media (prefers-color-scheme: dark) {
        .modal-footer {
          border-top-color: var(--slate-dark);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <app-header current-page="app" id="app-header"></app-header>

      <!-- Setup -->
      <div class="view setup-page" id="view-setup">
        <h1 class="page-title">
          Setup
          <svg class="setup-check hidden" id="setup-check" width="24" height="24" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: middle; margin-left: 4px;">
            <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0Zm3.78 5.22a.75.75 0 0 0-1.06 0L7 8.94 5.28 7.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.06 0l4.25-4.25a.75.75 0 0 0 0-1.06Z"/>
          </svg>
        </h1>

        <ul class="todo-list">
          <li class="todo-item">
            <span class="todo-number">1.</span>
            <div class="todo-content">
              <p>Go to <a href="https://account.apple.com/account" target="_blank">account.apple.com</a> to create an Apple Account only to use for Screen Time recovery</p>
            </div>
            <div class="todo-checkbox" id="checkbox-create-account"></div>
          </li>
          <li class="todo-item" id="todo-credentials">
            <span class="todo-number">2.</span>
            <div class="todo-content">
              <p>Store the Apple Account credentials here</p>
              <p class="note">If you generated the password via a password manager, make sure to delete it from there. Otherwise you would be able to bypass the screen time block.</p>
              <div class="form-group" style="margin-top: var(--1);">
                <label for="apple-id">Apple Account email</label>
                <input
                  type="email"
                  id="apple-id"
                  placeholder="blocker-recovery@icloud.com"
                />
              </div>
              <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Paste password" />
              </div>
            </div>
            <div class="todo-checkbox" id="checkbox-credentials"></div>
          </li>
        </ul>

        <ds-button primary id="go-to-schedule-btn" disabled>Go to schedule</ds-button>
      </div>

      <!-- Main: Idle -->
      <div class="view" id="view-idle">
        <div id="schedule-editor-idle"></div>

        <!-- Help popup -->
        <div class="help-popup hidden" id="schedule-help-popup">
          <div class="help-popup-content">
            <button class="help-popup-close" id="schedule-help-close">&times;</button>
            <h4>How to create sessions</h4>
            <ul>
              <li>Drag on the calendar to create blocking sessions</li>
              <li>Click a block to toggle weekly repeat (green tint = recurring)</li>
              <li>Right-click or long press to delete</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Main: Blocking -->
      <div class="view" id="view-blocking">
        <div class="blocking-card">
          <div class="blocking-card-content">
            <p class="blocking-session-title" id="blocking-session-title">Your session has started</p>
            <p class="blocking-session-time" id="blocking-session-time"></p>
          </div>
        </div>
        <p class="blocking-helper-text">
          Your Screen Time credentials will be shown in the blue rectangle by the end of the session
        </p>
      </div>

      <!-- Main: Session Ended (credentials reveal) -->
      <div class="view" id="view-session-ended">
        <div class="blocking-card">
          <div class="blocking-card-content">
            <p class="session-ended-title" id="session-ended-title">Your session has ended</p>
            <p class="credentials-label">This is your recovery Apple Account credentials</p>
            <div class="credential-box">
              <p class="credential-box-label">Email</p>
              <p class="credential-box-value" id="revealed-email">—</p>
            </div>
            <div class="credential-box">
              <p class="credential-box-label">Password</p>
              <p class="credential-box-value" id="revealed-password">—</p>
            </div>
          </div>
        </div>

        <div class="session-ended-instructions">
          <h3>How to unlock Screen Time Settings</h3>
          <ol>
            <li>Open System Settings → Screen Time</li>
            <li>Click "Change Passcode…" then "Forgot Passcode?"</li>
            <li>Sign in with the Apple Account above to reset the Screen Time passcode</li>
          </ol>
        </div>

        <ds-button primary class="close-session-btn" id="close-session-btn">Close session</ds-button>
      </div>


      <!-- Settings -->
      <div class="view" id="view-settings">
        <h1 class="page-title">Settings</h1>

        <div class="settings-section">
          <h3 class="settings-section-title">Account</h3>
          <p class="settings-email" id="settings-user-email"></p>
        </div>

        <div class="settings-section">
          <h3 class="settings-section-title">Recovery credentials</h3>
          <p class="settings-description">
            Apple Account used for Screen Time passcode recovery.
          </p>
          <p class="settings-credential-display" id="settings-credential-display">Not configured</p>
          <ds-button secondary id="change-credentials-btn">Change credentials</ds-button>
          <p class="settings-blocked-notice hidden" id="credentials-blocked-notice">Cannot change during blocking</p>
        </div>

        <div class="settings-section">
          <h3 class="settings-section-title">Notifications</h3>
          <p class="settings-notification-row">
            <span class="notification-status" id="notification-status">Disabled</span>
          </p>
          <p class="settings-description">
            Reminds you to start blocking when a session begins.
          </p>
          <ds-button secondary id="enable-notifications-btn" class="hidden">Enable notifications</ds-button>
        </div>

        <div class="settings-section">
          <h3 class="settings-section-title">Calendar</h3>
          <div class="toggle-row">
            <span class="toggle-label">Show 24 hour calendar</span>
            <div class="toggle-switch" id="toggle-24h"></div>
          </div>
          <div class="settings-select">
            <span class="toggle-label">First day of week</span>
            <select id="first-day-of-week">
              <option value="0">Sunday</option>
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
        </div>

        <div class="settings-section hidden" id="admin-section">
          <h3 class="settings-section-title">Admin</h3>
          <a href="admin.html" class="admin-link">Open admin panel</a>
        </div>

        <ds-button secondary id="settings-logout">Log out</ds-button>
      </div>

      <!-- Credentials Modal -->
      <div class="modal-overlay hidden" id="credentials-modal">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">Change credentials</h3>
            <button class="modal-close" id="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <p class="settings-description">
              Apple Account used for Screen Time passcode recovery.
            </p>
            <div class="form-group">
              <label for="edit-apple-id">Apple ID email</label>
              <input
                type="email"
                id="edit-apple-id"
                placeholder="blocker-recovery@icloud.com"
              />
            </div>
            <div class="form-group">
              <label for="edit-password">Password (leave blank to keep current)</label>
              <input
                type="password"
                id="edit-password"
                placeholder="Paste new password"
              />
            </div>
          </div>
          <div class="modal-footer">
            <ds-button secondary id="modal-cancel">Cancel</ds-button>
            <ds-button primary id="save-credentials">Save</ds-button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        getToken,
        setToken,
        generateVaultToken,
        getVault,
        getPassword,
        saveCredentials,
        syncScheduleToWorker,
      } from "./js/api.js";
      import {
        initAuth,
        isAuthenticated,
        clearAuth,
        getCurrentJwt,
      } from "./js/auth.js";
      import { convex } from "./js/convex.js";
      import { createScheduleEditor } from "./js/schedule.js";
      import {
        isSupported as notificationsSupported,
        getPermission,
        requestPermission,
        scheduleBlockingNotifications,
      } from "./js/notifications.js";
      import "./js/components/app-header.js";

      // State
      let vault = null;
      let sessions = [];
      let vaultToken = null;
      let idleEditor = null;
      let countdownInterval = null;
      let pollInterval = null;
      let sessionJustEnded = false;
      let endedSessionInfo = null;

      // Check for Convex auth
      async function checkAuth() {
        initAuth();
        if (!isAuthenticated()) {
          window.location.href = "index.html";
          return false;
        }

        // Set auth on convex client and fetch user email
        try {
          const jwt = getCurrentJwt();
          if (jwt) {
            convex.setAuth(() => jwt);
            const { api } = await import("./convex/_generated/api.js");
            const user = await convex.query(api.users.current);
            if (user?.email) {
              const settingsEmail = document.getElementById("settings-user-email");
              if (settingsEmail) {
                settingsEmail.textContent = user.email;
              }
            }

            // Check if admin and show admin section
            console.log("About to check admin, api.admin:", api.admin);
            try {
              const isAdmin = await convex.query(api.admin.isAdmin);
              console.log("Admin check result:", isAdmin);
              if (isAdmin) {
                const adminSection = document.getElementById("admin-section");
                console.log("Found admin section:", adminSection);
                if (adminSection) {
                  adminSection.classList.remove("hidden");
                  console.log("Admin section shown");
                }
              }
            } catch (adminErr) {
              console.error("Admin check failed:", adminErr);
            }
          }
        } catch (err) {
          console.error("Failed to fetch user:", err);
        }

        // Get vault token (separate from Convex auth)
        vaultToken = getToken();
        return true;
      }

      // View management
      function showView(viewId) {
        document.querySelectorAll(".view").forEach((v) => {
          v.classList.remove("active");
        });
        document.getElementById(viewId)?.classList.add("active");
        updateNav(viewId);
      }

      // Nav management
      function updateNav(viewId) {
        const navItems = document.querySelectorAll(".nav-item[data-nav]");
        navItems.forEach((item) => item.classList.remove("active"));
      }

      // Settings navigation from header component
      document.addEventListener("navigate-settings", () => {
        updateSettingsView();
        showView("view-settings");
      });

      // Update settings view state
      function updateSettingsView() {
        updateNotificationStatus();
        updateCalendarSettings();

        // Update credential display
        const credentialDisplay = document.getElementById("settings-credential-display");
        const changeBtn = document.getElementById("change-credentials-btn");
        const blockedNotice = document.getElementById("credentials-blocked-notice");

        if (vault?.screenTimeAppleId && vault?.hasStoredPassword) {
          credentialDisplay.textContent = `${vault.screenTimeAppleId} • ••••••••`;
        } else if (vault?.screenTimeAppleId) {
          credentialDisplay.textContent = `${vault.screenTimeAppleId} (no password)`;
        } else {
          credentialDisplay.textContent = "Not configured";
        }

        // Disable change button during blocking
        if (vault?.isBlocking) {
          changeBtn.setAttribute("disabled", "true");
          blockedNotice.classList.remove("hidden");
        } else {
          changeBtn.removeAttribute("disabled");
          blockedNotice.classList.add("hidden");
        }
      }

      // Credentials modal handlers
      function openCredentialsModal() {
        if (vault?.isBlocking) return;

        // Populate modal fields
        document.getElementById("edit-apple-id").value = vault?.screenTimeAppleId || "";
        document.getElementById("edit-password").value = "";
        document.getElementById("credentials-modal").classList.remove("hidden");
      }

      function closeCredentialsModal() {
        document.getElementById("credentials-modal").classList.add("hidden");
      }

      document.getElementById("change-credentials-btn").addEventListener("click", openCredentialsModal);
      document.getElementById("modal-close").addEventListener("click", closeCredentialsModal);
      document.getElementById("modal-cancel").addEventListener("click", closeCredentialsModal);

      // Close modal on overlay click
      document.getElementById("credentials-modal").addEventListener("click", (e) => {
        if (e.target.id === "credentials-modal") {
          closeCredentialsModal();
        }
      });

      // Logo click - go to main app view (always use updateView to ensure correct state)
      document.addEventListener("navigate-home", () => {
        updateView();
      });

      // Settings page handlers
      document.getElementById("settings-logout").addEventListener("click", () => {
        clearAuth();
        localStorage.removeItem("blocker_token");
        window.location.href = "index.html";
      });

      document.getElementById("enable-notifications-btn").addEventListener("click", async () => {
        await requestPermission();
        updateNotificationStatus();
      });

      // Close session button - clears ended state and returns to idle
      document.getElementById("close-session-btn").addEventListener("click", async () => {
        sessionJustEnded = false;
        endedSessionInfo = null;
        // Reload vault to get fresh state and show idle view
        await loadVault();
      });

      function updateNotificationStatus() {
        const status = document.getElementById("notification-status");
        const enableBtn = document.getElementById("enable-notifications-btn");
        const permission = getPermission();
        if (permission === "granted") {
          status.textContent = "Enabled";
          status.classList.add("enabled");
          enableBtn.classList.add("hidden");
        } else {
          status.textContent = "Disabled";
          status.classList.remove("enabled");
          enableBtn.classList.remove("hidden");
        }
      }

      // Calendar preferences
      function getCalendarPreferences() {
        return {
          show24Hours: localStorage.getItem("blocker_show24h") === "true",
          firstDayOfWeek: parseInt(localStorage.getItem("blocker_first_day") || "1"), // Default to Monday (1)
        };
      }

      function setCalendarPreference(key, value) {
        localStorage.setItem(key, value);
        // Refresh schedule editor if it exists
        if (idleEditor) {
          const prefs = getCalendarPreferences();
          idleEditor.setPreferences(prefs);
        }
      }

      function updateCalendarSettings() {
        const prefs = getCalendarPreferences();

        // Update 24h toggle
        const toggle24h = document.getElementById("toggle-24h");
        if (prefs.show24Hours) {
          toggle24h.classList.add("active");
        } else {
          toggle24h.classList.remove("active");
        }

        // Update first day of week select
        const firstDaySelect = document.getElementById("first-day-of-week");
        firstDaySelect.value = prefs.firstDayOfWeek.toString();
      }

      // Calendar settings event listeners
      document.getElementById("toggle-24h").addEventListener("click", () => {
        const toggle = document.getElementById("toggle-24h");
        const isActive = toggle.classList.toggle("active");
        setCalendarPreference("blocker_show24h", isActive.toString());
      });

      document.getElementById("first-day-of-week").addEventListener("change", (e) => {
        setCalendarPreference("blocker_first_day", e.target.value);
      });

      // Update header status indicator
      function updateHeaderStatus(isBlocking, activeUntil = null) {
        const header = document.getElementById("app-header");
        if (header) {
          header.isBlocking = isBlocking;
          header.activeUntil = activeUntil;
        }
      }

      // Help popup handlers
      document.getElementById("schedule-help-close").addEventListener("click", () => {
        document.getElementById("schedule-help-popup").classList.add("hidden");
      });

      document.getElementById("schedule-help-popup").addEventListener("click", (e) => {
        if (e.target.id === "schedule-help-popup") {
          document.getElementById("schedule-help-popup").classList.add("hidden");
        }
      });

      // Todo checkbox click handlers (skip disabled checkboxes)
      document.querySelectorAll(".todo-checkbox").forEach((checkbox) => {
        checkbox.addEventListener("click", () => {
          if (!checkbox.classList.contains("disabled")) {
            checkbox.classList.toggle("checked");
            // Update button state when step 1 is toggled
            updateGoToScheduleButton();
          }
        });
      });

      function updateGoToScheduleButton() {
        const createAccountCheckbox = document.getElementById("checkbox-create-account");
        const credentialsCheckbox = document.getElementById("checkbox-credentials");
        const goToScheduleBtn = document.getElementById("go-to-schedule-btn");
        const step1Complete = createAccountCheckbox.classList.contains("checked");
        const step2Complete = credentialsCheckbox.classList.contains("checked");
        if (step1Complete && step2Complete) {
          goToScheduleBtn.removeAttribute("disabled");
          goToScheduleBtn.disabled = false;
        } else {
          goToScheduleBtn.setAttribute("disabled", "true");
          goToScheduleBtn.disabled = true;
        }
      }

      // Update credentials checkbox state instantly
      function updateCredentialsState() {
        const appleId = document.getElementById("apple-id").value.trim();
        const password = document.getElementById("password").value;
        const checkbox = document.getElementById("checkbox-credentials");
        const createAccountCheckbox = document.getElementById("checkbox-create-account");

        // Check if BOTH apple id AND password are filled
        const isComplete = appleId && password;

        if (isComplete) {
          checkbox.classList.add("checked");
          // Also check and disable step 1 since having credentials means account was created
          createAccountCheckbox.classList.add("checked");
          createAccountCheckbox.classList.add("disabled");
        } else {
          checkbox.classList.remove("checked");
          // Re-enable step 1 if no stored credentials
          if (!vault?.screenTimeAppleId) {
            createAccountCheckbox.classList.remove("disabled");
          }
        }

        // Update button state
        updateGoToScheduleButton();
      }

      document.getElementById("apple-id").addEventListener("input", updateCredentialsState);
      document.getElementById("password").addEventListener("input", updateCredentialsState);
      // Also listen for change events (for autofill/paste that might not trigger input)
      document.getElementById("apple-id").addEventListener("change", updateCredentialsState);
      document.getElementById("password").addEventListener("change", updateCredentialsState);

      // Format time
      function formatTime(date) {
        return date.toLocaleTimeString([], {
          hour: "numeric",
          minute: "2-digit",
        });
      }

      // Format relative time
      function formatRelativeTime(date) {
        const now = new Date();
        const diffMs = date - now;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor(
          (diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );

        if (diffDays === 0) {
          if (diffHours === 0) {
            return "less than an hour";
          }
          return `${diffHours} hour${diffHours === 1 ? "" : "s"}`;
        } else if (diffDays === 1) {
          return "tomorrow";
        } else {
          return `in ${diffDays} days`;
        }
      }

      // Check if blocking has ended
      async function checkBlockingEnd(activeUntil, activeSession) {
        const now = new Date();
        const until = new Date(activeUntil);
        const diffMs = until - now;

        if (diffMs <= 0) {
          // Blocking ended, show session-ended view with credentials
          clearInterval(countdownInterval);
          sessionJustEnded = true;
          endedSessionInfo = activeSession;
          await showSessionEndedView();
        }
      }

      // Show session ended view with revealed credentials
      async function showSessionEndedView() {
        // Update title with session name
        const titleEl = document.getElementById("session-ended-title");
        if (endedSessionInfo?.title) {
          titleEl.textContent = `Your ${endedSessionInfo.title} session has ended`;
        } else {
          titleEl.textContent = "Your session has ended";
        }

        // Show email from vault
        const emailEl = document.getElementById("revealed-email");
        emailEl.textContent = vault?.screenTimeAppleId || "—";

        // Fetch and show password
        const passwordEl = document.getElementById("revealed-password");
        try {
          const result = await getPassword(vaultToken);
          if (result.blocked) {
            passwordEl.textContent = "Still blocked";
          } else {
            passwordEl.textContent = result.password || "—";
          }
        } catch (err) {
          console.error("Failed to fetch password:", err);
          passwordEl.textContent = "Error loading";
        }

        // Update header to show not blocking
        updateHeaderStatus(false, null);

        showView("view-session-ended");
      }

      // Update blocking card content
      function updateBlockingCard(session, activeUntil) {
        const titleEl = document.getElementById("blocking-session-title");
        const timeEl = document.getElementById("blocking-session-time");

        if (!session) {
          titleEl.textContent = "Your session has started";
          timeEl.innerHTML = "";
          return;
        }

        // Session title
        const sessionTitle = session.title || "Blocked";
        titleEl.textContent = `Your ${sessionTitle} session has started`;

        // Format date and time
        const startDate = new Date(activeUntil);
        startDate.setHours(session.startHour, session.startMinute, 0);

        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const month = months[startDate.getMonth()];
        const day = startDate.getDate();

        const formatTimeShort = (h, m) => `${h}:${m.toString().padStart(2, "0")}`;
        const startTime = formatTimeShort(session.startHour, session.startMinute);
        const endTime = formatTimeShort(session.endHour, session.endMinute);

        timeEl.innerHTML = `<span class="date">${month} ${day}</span> ${startTime}-${endTime}`;
      }

      // Show appropriate view based on state
      function updateView() {
        clearInterval(countdownInterval);

        // Use sessions from state (Convex) or fall back to vault sessions
        const displaySessions = sessions.length > 0 ? sessions : (vault?.sessions || []);

        // Check if setup is complete (has both Apple ID and password stored)
        const isSetUp = vault?.screenTimeAppleId && vault?.hasStoredPassword;

        // Update header status
        updateHeaderStatus(vault?.isBlocking || false, vault?.activeUntil || null);

        if (!isSetUp) {
          // Setup not complete, show setup view
          showView("view-setup");
          return;
        }

        // If session just ended, stay on session-ended view
        if (sessionJustEnded) {
          return;
        }

        if (vault?.isBlocking) {
          // Currently blocking
          showView("view-blocking");

          // Find the active session
          const activeSession = vault.activeSessionId
            ? displaySessions.find(s => s.id === vault.activeSessionId)
            : null;

          // Update the blocking card content
          updateBlockingCard(activeSession, vault.activeUntil);

          // Check for blocking end every second
          countdownInterval = setInterval(
            () => checkBlockingEnd(vault.activeUntil, activeSession),
            1000
          );
        } else {
          // Idle
          showView("view-idle");

          // Get locked session ID if currently blocking
          const lockedSessionId = vault?.activeSessionId || null;

          // Create editable schedule editor
          if (!idleEditor) {
            idleEditor = createScheduleEditor(
              document.getElementById("schedule-editor-idle"),
              displaySessions,
              async (newSessions) => {
                sessions = newSessions;
                // Auto-save on change
                if (vaultToken) {
                  try {
                    await syncScheduleToWorker(vaultToken, sessions);
                    // Update next session text after save
                    await loadVault();
                  } catch (err) {
                    console.error("Failed to auto-save:", err);
                  }
                }
              },
              { lockedSessionId }
            );
            // Apply calendar preferences
            idleEditor.setPreferences(getCalendarPreferences());
          } else {
            idleEditor.setSessions(displaySessions);
          }

          // Update next session text (inside schedule editor)
          if (vault?.nextSession) {
            const startsAt = new Date(vault.nextSession.startsAt);
            const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            const time = startsAt.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: false });
            idleEditor.setNextSessionText(`Next session begins ${days[vault.nextSession.day]} ${time} (${formatRelativeTime(startsAt)})`);
          } else if (displaySessions.length === 0) {
            idleEditor.setNextSessionText("No sessions scheduled");
          } else {
            idleEditor.setNextSessionText("");
          }

        }

        // Schedule notifications
        if (displaySessions.length > 0 && getPermission() === "granted") {
          scheduleBlockingNotifications(displaySessions);
        }
      }

      // Load vault state from Worker
      async function loadVault() {
        try {
          // Get vault state from Worker (blocking status, credentials, schedule)
          if (vaultToken) {
            vault = await getVault(vaultToken);
            if (vault?.sessions) {
              sessions = vault.sessions;
            }

            // Sync vault token to Convex if vault exists but not in Convex
            if (vault) {
              try {
                const { api } = await import("./convex/_generated/api.js");
                const convexVaultToken = await convex.query(api.schedules.getVaultToken);
                if (!convexVaultToken) {
                  await convex.mutation(api.schedules.setVaultToken, { vaultToken });
                  console.log("Synced vault token to Convex");
                }
              } catch (syncErr) {
                console.warn("Could not sync vault token to Convex:", syncErr);
              }
            }
          } else {
            vault = null;
          }

          // Auto-check credentials if both fields are set
          const credentialsCheckbox = document.getElementById("checkbox-credentials");
          const createAccountCheckbox = document.getElementById("checkbox-create-account");

          if (vault?.screenTimeAppleId) {
            // Populate the apple ID field
            document.getElementById("apple-id").value = vault.screenTimeAppleId;

            // Only mark as complete if password is also stored
            if (vault?.hasStoredPassword) {
              document.getElementById("password").placeholder = "Password stored (leave blank to keep)";
              credentialsCheckbox.classList.add("checked");
              // Also check and disable step 1 since having credentials means account was created
              createAccountCheckbox.classList.add("checked");
              createAccountCheckbox.classList.add("disabled");
            } else {
              // Apple ID exists but no password - step not complete
              credentialsCheckbox.classList.remove("checked");
            }
          } else {
            // Enable step 1 if no credentials
            createAccountCheckbox.classList.remove("disabled");
          }

          // Show setup checkmark if credentials are complete
          const setupCheck = document.getElementById("setup-check");
          if (vault?.screenTimeAppleId && vault?.hasStoredPassword) {
            setupCheck.classList.remove("hidden");
          } else {
            setupCheck.classList.add("hidden");
          }

          // Update "Go to schedule" button state
          updateGoToScheduleButton();

          updateView();
        } catch (err) {
          console.error("Failed to load vault:", err);
        }
      }

      // Go to schedule button - saves credentials first if filled, then shows idle view
      document.getElementById("go-to-schedule-btn").addEventListener("click", async () => {
        const appleId = document.getElementById("apple-id").value.trim();
        const password = document.getElementById("password").value;

        // If credentials are filled, save them first
        if (appleId && password) {
          try {
            // Generate vault token if needed
            if (!vaultToken) {
              vaultToken = generateVaultToken();
            }

            await saveCredentials(vaultToken, {
              screenTimeAppleId: appleId,
              screenTimePassword: password,
              sessions,
            });
            setToken(vaultToken);

            // Save vault token to Convex (for admin panel visibility)
            const { api } = await import("./convex/_generated/api.js");
            await convex.mutation(api.schedules.setVaultToken, { vaultToken });

            await loadVault();
          } catch (err) {
            alert("Failed to save credentials: " + err.message);
            return;
          }
        }

        // Show idle view with schedule editor
        showView("view-idle");
        updateView();
      });

      document
        .getElementById("save-credentials")
        .addEventListener("click", async () => {
          const appleId = document.getElementById("edit-apple-id").value.trim();
          const password = document.getElementById("edit-password").value;
          const saveBtn = document.getElementById("save-credentials");

          if (!appleId) {
            alert("Please enter an Apple ID");
            return;
          }

          try {
            if (!vaultToken) {
              alert("No vault token - please complete setup first");
              return;
            }

            saveBtn.setAttribute("disabled", "true");
            saveBtn.textContent = "Saving...";

            const data = { screenTimeAppleId: appleId };
            if (password) {
              data.screenTimePassword = password;
            }
            // Save credentials to Worker only
            await saveCredentials(vaultToken, data);

            // Update local vault state
            if (vaultToken) {
              vault = await getVault(vaultToken);
              if (vault?.sessions) {
                sessions = vault.sessions;
              }
            }

            // Close modal and update settings view
            closeCredentialsModal();
            updateSettingsView();

            saveBtn.removeAttribute("disabled");
            saveBtn.textContent = "Save";
          } catch (err) {
            saveBtn.removeAttribute("disabled");
            saveBtn.textContent = "Save";
            alert("Failed to save: " + err.message);
          }
        });

      // Screen Time settings
      function openScreenTimeSettings() {
        window.open(
          "x-apple.systempreferences:com.apple.preference.screentime",
          "_blank"
        );
      }

      // Poll for state changes (in case blocking ends while tab is open)
      pollInterval = setInterval(async () => {
        if (vault?.isBlocking) {
          await loadVault();
        }
      }, 30000); // Every 30 seconds

      // Initial load - check auth first, then load vault
      async function init() {
        if (await checkAuth()) {
          await loadVault();

          // Check if navigated from another page with settings intent
          if (sessionStorage.getItem("blocker-show-settings") === "true") {
            sessionStorage.removeItem("blocker-show-settings");
            updateSettingsView();
            showView("view-settings");
          }
        }
      }

      init();
    </script>
  </body>
</html>
